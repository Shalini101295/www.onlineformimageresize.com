<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Quick Fix</title>
    <link rel="icon" href="data:,">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin: 15px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <h1>üîß Quick Fix Debugging</h1>

    <div class="test">
        <h3>üíæ Current Storage</h3>
        <button onclick="showLocalStorage()">Show localStorage</button>
        <div id="localStorageResult"></div>
    </div>

    <div class="test">
        <h3>üîç Test File Scanner</h3>
        <button onclick="testQuickFix()">Test Quick File Scanner</button>
        <div id="quickFixResult"></div>
    </div>

    <div class="test">
        <h3>üìÅ Direct File Test</h3>
        <button onclick="testDirectFile()">Test Direct File Access</button>
        <div id="directFileResult"></div>
    </div>

    <div class="test">
        <h3>üõ†Ô∏è Manual Fix</h3>
        <p>If automatic detection fails, try these options:</p>
        <button onclick="scanAllFiles()" style="background: #28a745; margin: 5px;">üîç Scan All Files (Recommended)</button>
        <br>
        <input type="text" id="manualUserId" placeholder="Enter your user ID (e.g., shashank_sinha_0_4206)" style="width: 300px; padding: 5px;">
        <button onclick="manualFileScan()">Manual File Scan</button>
        <div id="manualResult"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        function showLocalStorage() {
            const resultDiv = document.getElementById('localStorageResult');
            const currentUser = localStorage.getItem('currentUser');
            const currentProject = localStorage.getItem('currentProject');
            
            resultDiv.innerHTML = `
                <h4>Current User:</h4>
                <pre>${currentUser || 'Not found'}</pre>
                <h4>Current Project:</h4>
                <pre>${currentProject || 'Not found'}</pre>
            `;
        }

        function testQuickFix() {
            const resultDiv = document.getElementById('quickFixResult');
            resultDiv.innerHTML = '<p>Testing quick fix...</p>';
            
            // Get user data
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                resultDiv.innerHTML = '<p style="color: red;">‚ùå No user data in localStorage</p>';
                return;
            }
            
            const user = JSON.parse(userData);
            const userId = user.id || user.username;
            
            console.log('Testing with user ID:', userId);
            
            // Test the quick file loader
            $.ajax({
                url: 'quick_file_loader.php',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'scan_user_files',
                    user_id: userId
                }),
                success: function(response) {
                    console.log('Quick fix response:', response);
                    resultDiv.innerHTML = `
                        <h4>Quick Fix Response:</h4>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    `;
                },
                error: function(xhr, status, error) {
                    console.error('Quick fix error:', error);
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error}</p>`;
                }
            });
        }

        function testDirectFile() {
            const resultDiv = document.getElementById('directFileResult');
            
            // First try to get the correct path from scan results
            const savedProjects = localStorage.getItem('quickFixProjects');
            if (savedProjects) {
                try {
                    const projects = JSON.parse(savedProjects);
                    if (projects.length > 0 && projects[0].files && projects[0].files.length > 0) {
                        const project = projects[0];
                        const file = project.files[0];
                        const correctPath = `${project.path}/${file.name}`;
                        
                        resultDiv.innerHTML = `<p>Testing direct access to: ${correctPath}</p>`;
                        
                        fetch(correctPath)
                            .then(response => {
                                if (response.ok) {
                                    resultDiv.innerHTML = `
                                        <div class="success">
                                            <p>‚úÖ Direct file access works!</p>
                                            <p>File: ${file.name}</p>
                                            <p>Size: ${file.size} bytes</p>
                                            <button onclick="loadKnownFile('${correctPath}')">Load This File</button>
                                        </div>
                                    `;
                                } else {
                                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Direct access failed: ${response.status}</p>`;
                                }
                            })
                            .catch(error => {
                                resultDiv.innerHTML = `<p style="color: red;">‚ùå Direct access error: ${error.message}</p>`;
                            });
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing saved projects:', e);
                }
            }
            
            // Fallback to old hardcoded path if no scan results
            const knownFilePath = 'user_projects/shashank_sinha_0_4206/Test_Project_proj_1752926209_3120/250720_New.xlsx';
            
            resultDiv.innerHTML = `<p>Testing direct access to: ${knownFilePath}</p>`;
            
            fetch(knownFilePath)
                .then(response => {
                    if (response.ok) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <p>‚úÖ Direct file access works!</p>
                                <p>File size: ${response.headers.get('content-length') || 'Unknown'}</p>
                                <button onclick="loadKnownFile('${knownFilePath}')">Load This File</button>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p style="color: red;">‚ùå Direct access failed: ${response.status}</p>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Direct access error: ${error.message}</p>`;
                });
        }

        function manualFileScan() {
            const resultDiv = document.getElementById('manualResult');
            const userId = document.getElementById('manualUserId').value.trim();
            
            if (!userId) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter a user ID</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Scanning for user: ' + userId + '</p>';
            
            $.ajax({
                url: 'quick_file_loader.php',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'scan_user_files',
                    user_id: userId
                }),
                success: function(response) {
                    console.log('Manual scan response:', response);
                    if (response.success && response.projects && response.projects.length > 0) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Found ${response.projects.length} project(s)!</h4>
                                <pre>${JSON.stringify(response, null, 2)}</pre>
                                <button onclick="useManualResults(${JSON.stringify(response).replace(/"/g, '&quot;')})">Use These Files</button>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå No files found</h4>
                                <pre>${JSON.stringify(response, null, 2)}</pre>
                            </div>
                        `;
                    }
                },
                error: function(xhr, status, error) {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error}</p>`;
                }
            });
        }

        function loadKnownFile(filePath) {
            console.log('Loading known file:', filePath);
            
            fetch(filePath)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    const workbook = XLSX.read(buffer, {type: 'array'});
                    console.log('‚úÖ File loaded! Sheets:', workbook.SheetNames);
                    alert('‚úÖ Excel file loaded successfully! Sheets: ' + workbook.SheetNames.join(', '));
                })
                .catch(error => {
                    console.error('Failed to load file:', error);
                    alert('Failed to load file: ' + error.message);
                });
        }

        function scanAllFiles() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.innerHTML = '<p>Scanning all files in user_projects directory...</p>';
            
            $.ajax({
                url: 'quick_file_loader.php',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'scan_all_files'
                }),
                success: function(response) {
                    console.log('Scan all response:', response);
                    if (response.success && response.projects && response.projects.length > 0) {
                        let projectsHtml = '<h4>üìÅ Found Projects:</h4>';
                        response.projects.forEach((project, i) => {
                            projectsHtml += `
                                <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px;">
                                    <strong>Project ${i + 1}: ${project.name}</strong><br>
                                    <small>Path: ${project.path}</small><br>
                                    <strong>Files:</strong><br>
                            `;
                            project.files.forEach(file => {
                                const fullPath = `${project.path}/${file.name}`;
                                projectsHtml += `
                                    üìä <a href="${fullPath}" target="_blank">${file.name}</a> 
                                    (${file.size} bytes) 
                                    <button onclick="testLoadFile('${project.path}', '${file.name}')" style="background: #007bff; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 12px; cursor: pointer;">Test Load</button><br>
                                `;
                            });
                            projectsHtml += '</div>';
                        });
                        
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Found ${response.projects.length} project(s) with Excel files!</h4>
                                ${projectsHtml}
                                <br>
                                <button onclick="useManualResults(${JSON.stringify(response).replace(/"/g, '&quot;')})">Save & Use These Files</button>
                                <details style="margin-top: 10px;">
                                    <summary>Show Raw JSON</summary>
                                    <pre>${JSON.stringify(response, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå No Excel files found anywhere</h4>
                                <pre>${JSON.stringify(response, null, 2)}</pre>
                            </div>
                        `;
                    }
                },
                error: function(xhr, status, error) {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error}</p>`;
                }
            });
        }

        function testLoadFile(projectPath, fileName) {
            console.log('üß™ Testing load file:', fileName, 'from', projectPath);
            const fullPath = `${projectPath}/${fileName}`;
            
            fetch(fullPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.arrayBuffer();
                })
                .then(buffer => {
                    const workbook = XLSX.read(buffer, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    const columns = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                    
                    console.log('‚úÖ File loaded! Sheets:', workbook.SheetNames);
                    console.log('üìä Data rows:', jsonData.length);
                    console.log('üìã Columns:', columns);
                    
                    alert(`‚úÖ ${fileName} loaded successfully!\nSheets: ${workbook.SheetNames.join(', ')}\nRows: ${jsonData.length}\nColumns: ${columns.join(', ')}\nSize: ${buffer.byteLength} bytes`);
                })
                .catch(error => {
                    console.error('‚ùå Failed to load file:', error);
                    alert(`‚ùå Failed to load ${fileName}: ${error.message}`);
                });
        }

        function useManualResults(response) {
            // Store the found projects in localStorage for the main app to use
            localStorage.setItem('quickFixProjects', JSON.stringify(response.projects));
            alert('‚úÖ File data saved! Go back to the Excel Visualizer and it should show your files.');
        }

        // Auto-populate user ID if we can guess it
        window.addEventListener('load', function() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    const userId = user.id || user.username;
                    if (userId) {
                        document.getElementById('manualUserId').value = userId;
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        });
    </script>
</body>
</html>